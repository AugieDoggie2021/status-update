name: Fetch Vercel Logs

on:
  workflow_dispatch:
    inputs:
      deploymentId:
        description: "Vercel deployment ID (from vercel.com URL)"
        required: true
      pr:
        description: "PR number to post comment to"
        required: true

jobs:
  fetch-logs:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Fetch logs JSON
        id: fetch
        run: |
          set -e
          curl -sS -H "Authorization: Bearer $VERCEL_TOKEN" \
            "https://api.vercel.com/v2/deployments/${{ inputs.deploymentId }}/events?limit=5000" > logs.json
          echo "saved logs.json"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: Format and post
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const prNumber = Number(github.event.inputs.pr);
            const rows = JSON.parse(fs.readFileSync('logs.json','utf8')).events || [];
            const lines = rows.map(r => (r.payload && r.payload.text) ? r.payload.text : '').filter(Boolean);
            const text = lines.join('\n');
            const max = 65000, body = text.length>max ? text.slice(-max) : text;
            const msg = [
              'ðŸ§¾ **Vercel Deployment Logs**',
              '',
              '<details><summary>Last ~65k of log</summary>',
              '',
              '```',
              body,
              '```',
              '',
              '</details>'
            ].join('\n');
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: msg
            });

